<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="board">

<!-- 특정 게시판의 댓글 목록 조회 -->
<select id="board_reply" resultType='vo.ReplyVO'>
select  *
from    (select r.*, member_name, row_number() over(order by reply_code) no 
        from board_reply r inner join member m 
        on r.writer = m.member_code 
        where board_code = #{board_code})
order by no desc
</select>

<!-- 특정 게시판의 파일 정보 조회 -->
<select id="file_list" resultType='vo.BoardFileVO'>
	select * from board_file where board_code = #{board_code}
</select>

<!-- 특정 첨부파일의 정보 조회 -->
<select id='file_info' resultType='vo.BoardFileVO'>
select * from board_file where boardfile_code = #{boardfile_code}
</select>

<!-- 특정 게시판 정보 조회 -->
<select id="board_info" resultType='vo.BoardVO'>
	select  *
	from    (select b.*, member_name member_name from board b inner join member m on b.writer = m.member_code)
	where	board_code = #{board_code}
</select>

<!-- 첨부파일 저장 -->
<insert id='file_insert'>
<foreach item="item" collection="fileList"
       open="insert all " separator=" " close="select * from dual">
      into board_file(board_code, file_name, path)
	  values( #{board_code}, #{item.file_name}, #{item.path} )
</foreach>
</insert>

<!-- 신규 글 저장 -->
<insert id='board_insert'>
	insert into board( title, content, writer, category )
	values( #{title}, #{content}, #{writer}, #{category} )
	<selectKey keyProperty="board_code" resultType="integer" order="AFTER">
		select seq_board.currval from dual
	</selectKey>
</insert>

<!-- 자유게시판 총 갯수 조회 -->
<select id="total" resultType='integer'>
	select count(*) from board where category = 'bo' <include refid='board_where'/>
	
</select>
<!-- 학원 공지사항 총 갯수 조회 -->
<select id="total_notice" resultType='integer'>
	select count(*) from board where category = 'no' and lecture_code is null <include refid='board_where'/>
</select>

<!-- 자유게시판 목록 조회 -->
<select id="board_list" resultType='vo.BoardVO'>
select (select count(*) from board_file f where b.board_code = f.board_code ) 
			fileCount, b.*
		from ( 	select row_number() over(order by board_code) no, member_name, b.* 
				from board b left outer join member m
				on b.writer = m.member_code
				where category = 'bo'
		<include refid='board_where'/>) b
where no between ${beginList} and ${endList}

order by no desc
</select>

<sql id='keyword'>'%'|| #{keyword} ||'%'</sql>
	
	<sql id='board_where'>
		<choose>
			<when test="search=='all'">
			and (title like <include refid='keyword'/>
			or content 	like '%'|| #{keyword} ||'%'
			or writer 	in 
				(select member_code from member where member_name like
				'%'|| #{keyword} ||'%'))
			</when>
			<when test="search=='title' or search=='content'">
			and ${search} like '%'|| #{keyword} ||'%'
			</when>
			<when test="search=='writer'">
			and writer 	in 
				(select member_code from member where member_name like
				'%'|| #{keyword} ||'%')
			</when>
		</choose>
		
	</sql>
	

<!-- 공지사항 목록 조회 -->
<select id='notice_list' resultType='vo.BoardVO'>
select (select count(*) from board_file f where b.board_code = f.board_code ) 
			fileCount, b.*
		from ( 	select row_number() over(order by board_code) no, member_name, b.* 
				from board b left outer join member m
				on b.writer = m.member_code
				where category = 'no'
				and lecture_code is null
		<include refid='board_where'/>) b
where no between ${beginList} and ${endList}

order by no desc
</select>

<!-- 조회수 증가처리 -->
<update id='board_read'>
	update board set readcnt = readcnt + 1 where board_code = #{board_code}
</update>

</mapper>